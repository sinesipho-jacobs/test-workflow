name: Reusable Test Workflow

on:
  workflow_call:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ðŸ“œ Install Robot Framework
        run: pip install robotframework

      - name: ðŸ— Create Test Results Directory
        run: mkdir -p webapp_tests/robot-test-results

      - name: ðŸƒ Run Robot Framework Tests
        run: |
          robot --output webapp_tests/robot-test-results/output.xml webapp_tests/tests

      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: robot-test-results
          path: webapp_tests/robot-test-results

  parse-results:
    runs-on: ubuntu-latest
    needs: run-tests
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: robot-test-results
          path: webapp_tests/robot-test-results

      - name: ðŸ“‚ List contents of the test results directory
        run: ls -alh webapp_tests/robot-test-results

      - name: âš¡ Check if output.xml exists
        run: |
          if [ ! -f webapp_tests/robot-test-results/output.xml ]; then
            echo "âŒ File 'output.xml' not found!"
            exit 1
          fi

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ðŸ“œ Install Robot Framework
        run: pip install robotframework

      - name: ðŸƒ Run Test Results Parsing Script
        run: python functions/display_test_results.py webapp_tests/robot-test-results/output.xml report.md

      - name: ðŸ“ Display Test Summary in GitHub UI
        run: cat report.md >> $GITHUB_STEP_SUMMARY
