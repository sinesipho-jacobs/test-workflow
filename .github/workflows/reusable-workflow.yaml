name: Run Robot Framework Tests (Reusable)

on:
  workflow_call:  # This allows other workflows to call this one

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4

      - name: "üêç Set up Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: "üìú Install Robot Framework"
        run: pip install robotframework

      - name: "üöÄ Run Robot Framework Tests"
        id: run_tests
        run: |
          mkdir -p webapp_tests/robot-test-results  # Ensure directory exists
          robot --output webapp_tests/robot-test-results/output.xml \
                 --log webapp_tests/robot-test-results/log.html \
                 --report webapp_tests/robot-test-results/report.html \
                 webapp_tests/tests/
          # Check if any tests failed
          if grep -q "FAIL" webapp_tests/robot-test-results/output.xml; then
            echo "Test failed!"
            echo "test_failed=true" >> $GITHUB_ENV
          else
            echo "Test passed!"
            echo "test_failed=false" >> $GITHUB_ENV
          fi

      - name: "‚¨ÜÔ∏è Upload Test Results"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-test-results
          path: webapp_tests/robot-test-results/

      - name: "‚¨áÔ∏è Download Test Results"
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: robot-test-results
          path: webapp_tests/robot-test-results/
      
      - name: "üêç Run Test Results Parsing Script"
        if: always()
        run: python functions/display_test_results.py ./webapp_tests/robot-test-results/output.xml webapp_tests/robot-test-results/report.md

      - name: "üìë Display parsed test results"
        if: always()
        run: |
          if [ -f webapp_tests/robot-test-results/report.md ]; then
            cat webapp_tests/robot-test-results/report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Report not found!" >> $GITHUB_STEP_SUMMARY
          fi


  post-check-run:
      runs-on: ubuntu-latest
      if: always()
      needs: run-tests
      steps:
        - name: "üì• Checkout Repository"
          uses: actions/checkout@v4
  
        - name: "üì§ Post Check Run to GitHub"
          run: |
            # Define variables for the check run
            CONCLUSION="success"
            SUMMARY="All tests passed successfully!"
            
            # Check the environment variable set during the test step
            if [ "${{ env.test_failed }}" == "true" ]; then
              CONCLUSION="failure"
              SUMMARY="Some tests failed. Check the logs for details."
            fi
  
            # Post the check run to GitHub
            curl -X POST https://api.github.com/repos/${{ github.repository }}/check-runs \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -d '{
                    "name": "Robot Framework Test Run",
                    "head_sha": "${{ github.sha }}",
                    "status": "completed",
                    "conclusion": "'$CONCLUSION'",
                    "output": {
                      "title": "Test Results Summary",
                      "summary": "'$SUMMARY'"
                    }
                  }'
  
        - name: "üìù Set job conclusion based on check result"
          run: |
            if [ "${{ env.test_failed }}" == "true" ]; then
              echo "Job failed due to test failure"
              exit 1
            else
              echo "Job passed"
            fi
