name: Run and Merge Robot Tests

on:
  # push:
  #   branches:
  #     - main
  # pull_request:
  workflow_dispatch:

jobs:
  call-web-tests:
    permissions:
      contents: read
      checks: write
      actions: write
    uses: sinesipho-jacobs/test-workflow/.github/workflows/reusable-workflow.yaml@main
    with:
      type: web
      job-name: automated-web-tests
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  call-api-tests:
    permissions:
      contents: read
      checks: write
      actions: write
    uses: sinesipho-jacobs/test-workflow/.github/workflows/reusable-workflow.yaml@main
    with:
      type: api
      job-name: automated-api-tests
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  display-combined-test-results:
      needs: [call-web-tests, call-api-tests]
      if: always()
      runs-on: ubuntu-latest
      permissions:
        contents: read
        checks: write
        actions: write
      steps:
        - name: "📥 Checkout Repository"
          uses: actions/checkout@v4
  
        - name: "🐍 Set up Python"
          uses: actions/setup-python@v4
          with:
            python-version: '3.9'
  
        - name: "📜 Install Requests"
          run: pip install requests
  
        - name: "📜 Install Robot Framework"
          run: pip install robotframework
  
        - name: "⬇️ Download Web Test Results"
          uses: actions/download-artifact@v4
          with:
            path: ./webapp_tests/robot-test-results/report.md

        - name: "⬇️ Download Web Test Results"
          uses: actions/download-artifact@v4
          with:
            path: ./webapp_tests/robot-test-results/
  
        - name: Debug:Check if report.md files exist
          run: |
            echo "Checking for report.md files..."
            find ./webapp_tests/robot-test-results/ -name "report.md"
            ls -la ./webapp_tests/robot-test-results/
        
        - name: Combine all report.md files into a single report
          if: always()
          run: |
            combined_report="./combined_report.md"
            echo "### Combined Test Results" > $combined_report
            # Check if files exist before attempting to combine
            report_files=$(find ./webapp_tests/robot-test-results/ -name "report.md")
            if [ -z "$report_files" ]; then
              echo "No report.md files found."
            else
              echo "Found report.md files, combining..."
              find ./webapp_tests/robot-test-results/ -name "report.md" -exec cat {} >> $combined_report \;
              echo "Combined report created: $combined_report"
            fi
            
        - name: Run Test Results Parsing Script
          if: always()
          run: python ./functions/display_test_results.py ./webapp_tests/robot-test-results/**/output.xml report.md
              
        - name: "Debug /robot-test-results"
          if: always()
          shell: bash
          run: | 
            pwd
            ls -lah .

        - name: "Debug /robot-test-results"
          if: always()
          shell: bash
          run: | 
            pwd
            ls -lah ./webapp_tests

        - name: "Debug /robot-test-results"
          if: always()
          shell: bash
          run: | 
            pwd
            ls -lah ./webapp_tests/robot-test-results

        # - name: Merge the Robot Framework XML files using Rebot
        #   run: |
        #     # Use rebot to combine all XML files in both folders (using wildcards)
        #     rebot --output output.xml ./webapp_tests/robot-test-results*/**/*.xml
    
        - name: "Post Test Results to GitHub Checks"
          # working-directory: test-workflow/webapp_tests
          if: always()
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            GITHUB_REPOSITORY: ${{ github.repository }}
            GITHUB_SHA: ${{ github.sha }}
            JOB_NAME: ${{ github.job }}
          run: python ./functions/check.py


  
 
