name: ESB Automated Tests

on:
  # push:
  #   branches:
  #     - master
    
  workflow_dispatch:

jobs:
  automated-api-tests:
    # runs-on: aurora-web
    permissions:
      contents: read
      checks: write
      actions: write
    uses: MagnaBC/Nucleus-Testing/.github/workflows/reusable-automated-tests.yaml@master
    with:
      type: api
      poetry-path: webapp_tests
      robot-test-path: esb/test_api.robot
      job-name: automated-api-tests
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  web-automated-register-tests:
    # runs-on: aurora-web
    permissions:
      contents: read
      checks: write
      actions: write
    uses: MagnaBC/Nucleus-Testing/.github/workflows/reusable-automated-tests.yaml@master
    with:
      type: web
      poetry-path: webapp_tests
      robot-test-path: register/register.robot
      job-name: web-automated-register-tests
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  web-automated-manage-roles-tests:
     # runs-on: aurora-web
     permissions:
       contents: read
       checks: write
       actions: write
     uses: MagnaBC/Nucleus-Testing/.github/workflows/reusable-automated-tests.yaml@master
     with:
       type: web
       poetry-path: webapp_tests
       robot-test-path: roles/manage_roles.robot
       job-name: web-automated-manage-roles-tests
     secrets:
       GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  display-combined-test-results:
    needs: [automated-api-tests, web-automated-register-tests, web-automated-manage-roles-tests]
    if: always()
    runs-on: ubuntu-latest
    permissions:
        contents: read
        checks: write
        actions: write
    steps:
    - name: "Checkout Repository"
      uses: actions/checkout@v4
      with:
        ref: master
        repository: MagnaBC/Nucleus-Testing
        token: ${{ secrets.GITHUB_TOKEN }}
        path: Nucleus-Testing

    - name: "Install Poetry"
      shell: bash
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        poetry --version

    - name: "Add Poetry to PATH"
      shell: bash
      run: |
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo $PATH #debug

    - name: "Poetry Install"
      run: |     
        cd Nucleus-Testing/webapp_tests || exit 1     
        export PATH="$HOME/.local/bin:$PATH"     
        poetry install

    - name: Download Test Results Artifacts
      if: always()
      uses: actions/download-artifact@v4
      with:
        path: Nucleus-Testing/webapp_tests/

    - name: Find and merge Robot Framework logs
      run: |
        OUTPUT_FILES=$(find Nucleus-Testing/webapp_tests -name "output.xml" | tr '\n' ' ')
        if [ -n "$OUTPUT_FILES" ]; then
          rebot --output Nucleus-Testing/webapp_tests/output.xml --log Nucleus-Testing/webapp_tests/log.html --report Nucleus-Testing/webapp_tests/report.html $OUTPUT_FILES
        else
          echo "No output.xml files found. Skipping merging."

    - name: "Run Combined Test Results Parsing Script"
      working-directory: Nucleus-Testing/webapp_tests
      if: always()
      run: poetry run python ${{ github.workspace }}/Nucleus-Testing/functions/display_test_results.py

    - name: "Post Test Results to GitHub Checks"
      if: always()
      working-directory: Nucleus-Testing/webapp_tests
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
        JOB_NAME: ${{ github.job }}
      run: poetry run python ${{ github.workspace }}/Nucleus-Testing/functions/check_github_run.py
