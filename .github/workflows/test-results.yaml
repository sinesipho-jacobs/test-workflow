name: Run and Merge Robot Tests

on:
  workflow_dispatch:

jobs:
  call-web-tests:
    permissions:
      contents: read
      checks: write
      actions: write
    uses: sinesipho-jacobs/test-workflow/.github/workflows/reusable-workflow.yaml@main
    with:
      type: web
      job-name: automated-web-tests
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  call-api-tests:
    permissions:
      contents: read
      checks: write
      actions: write
    uses: sinesipho-jacobs/test-workflow/.github/workflows/reusable-workflow.yaml@main
    with:
      type: api
      job-name: automated-api-tests
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  merge-and-deploy:
    needs: [call-web-tests, call-api-tests]
    runs-on: ubuntu-latest
    steps:
      - name: "游닌 Checkout Repository"
        uses: actions/checkout@v4

      - name: "游냀 Set up Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: "游닆 Install Required Libraries"
        run: pip install requests robotframework

      - name: "拘勇 Download Test Results"
        uses: actions/download-artifact@v4
        with:
          path: ./robot-test-results/

      - name: Find and Merge Robot Framework logs
        run: |
          mkdir -p merged-results/
          find ./robot-test-results -name "*.xml" -exec mv {} ./merged-results/ \;

          OUTPUT_FILES=$(find ./merged-results -name "output.xml" | tr '\n' ' ')
          if [ -n "$OUTPUT_FILES" ]; then
            echo "Merging output files: $OUTPUT_FILES"
            rebot --output ./merged-results/output.xml --log ./merged-results/log.html --report ./merged-results/report.html $OUTPUT_FILES
          else
            echo "No output.xml files found. Skipping merging."
            exit 1
          fi

      - name: "拘勇 Upload Merged Test Results"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: merged-results
          path: |
            merged-results/output.xml
            merged-results/log.html
            merged-results/report.html

      - name: "Post Test Results to GitHub Checks"
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          JOB_NAME: ${{ github.job }}
        run: python ./functions/check.py

  push-logs-to-mkdocs-repo:
    needs: run-tests
    runs-on: ubuntu-latest
    steps:
      - name: "游닌 Checkout Main Repository"
        uses: actions/checkout@v4

      - name: "拘勇 Download Test Results"
        uses: actions/download-artifact@v4
        with:
          name: merged-results
          path: ./merged-results

      - name: "游닌 Clone MkDocs Repository"
        uses: actions/checkout@v4
        with:
          repository: https://github.com/sinesipho-jacobs/robot-logs/tree/main/docs
          path: docs
          token: ${{ secrets.GITHUB_TOKEN }}  # Use GITHUB_TOKEN instead of PAT

      - name: "游늭 Copy Logs to MkDocs Docs Folder"
        run: |
          cp -r ./merged-results/* ./docs/

      - name: "游 Commit and Push Changes"
        run: |
          cd mkdocs-reports
          git config --global sinesipho.jacobs
          git config --global sinesipho.jacobs@gmail.com
          git add .
          git commit -m "Update Robot Framework logs"
          git push origin main
          
  build-and-deploy-mkdocs:
    needs: push-logs-to-mkdocs-repo
    runs-on: ubuntu-latest
    steps:
      - name: "游닌 Checkout MkDocs Repository"
        uses: actions/checkout@v4
        with:
          repository: <your-username>/mkdocs-reports
          path: mkdocs-reports
          token: ${{ secrets.GITHUB_TOKEN }}  # Use GITHUB_TOKEN instead of PAT

      - name: "游닆 Install MkDocs"
        run: pip install mkdocs

      - name: "游 Build MkDocs Site"
        run: |
          cd mkdocs-reports
          mkdocs build

      - name: "游 Deploy to Cloudflare Pages"
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: mkdocs-reports
          directory: mkdocs-reports/site

      - name: "游댕 Add Cloudflare Pages Link to Summary"
        run: |
          echo "## 游늯 Robot Framework Reports" >> $GITHUB_STEP_SUMMARY
          echo "[View Reports on Cloudflare Pages](https://<your-project-name>.pages.dev)" >> $GITHUB_STEP_SUMMARY
