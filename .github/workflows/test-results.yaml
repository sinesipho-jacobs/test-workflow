name: Run and Merge Robot Tests

on:
  workflow_dispatch:

jobs:
  call-web-tests:
    permissions:
      contents: read
      checks: write
      actions: write
    uses: sinesipho-jacobs/test-workflow/.github/workflows/reusable-workflow.yaml@main
    with:
      type: web
      job-name: automated-web-tests
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  call-api-tests:
    permissions:
      contents: read
      checks: write
      actions: write
    uses: sinesipho-jacobs/test-workflow/.github/workflows/reusable-workflow.yaml@main
    with:
      type: api
      job-name: automated-api-tests
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  merge-and-deploy:
    needs: [call-web-tests, call-api-tests]
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
  
      - name: "ðŸ Set up Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
  
      - name: "ðŸ“œ Install Required Libraries"
        run: pip install requests robotframework

      - name: "â¬‡ï¸ Download Test Results"
        uses: actions/download-artifact@v4
        with:
          path: ./robot-test-results/
          
      - name: Debug Artifacts
        run: |
          echo "Listing downloaded artifacts:"
          find ./robot-test-results -type f

      - name: Find and Merge Robot Framework logs
        run: |
          mkdir -p merged-results
          find ./robot-test-results -name "*.xml" -exec mv {} ./merged-results/ \;

          OUTPUT_FILES=$(find ./merged-results -name "output.xml" | tr '\n' ' ')
          if [ -n "$OUTPUT_FILES" ]; then
            echo "Merging output files: $OUTPUT_FILES"
            rebot --output ./merged-results/merged-output.xml --log ./merged-results/merged-log.html --report ./merged-results/merged-report.html $OUTPUT_FILES
          else
            echo "No output.xml files found. Skipping merging."
            exit 1
          fi

      - name: Debug Merged Results
        run: |
          echo "Listing merged results:"
          ls -la ./merged-results
          echo "Contents of merged-output.xml:"
          cat ./merged-results/merged-output.xml || echo "merged-output.xml not found"
          echo "Contents of merged-log.html:"
          cat ./merged-results/merged-log.html || echo "merged-log.html not found"
          echo "Contents of merged-report.html:"
          cat ./merged-results/merged-report.html || echo "merged-report.html not found"

      - name: "ðŸ“¤ Upload Test Reports"
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./merged-results"  # Uploads merged reports from the merged-results directory

      - name: "ðŸš€ Deploy to GitHub Pages"
        id: deployment
        uses: actions/deploy-pages@v4

      - name: "ðŸ”— Add GitHub Pages Link to Summary"
        run: |
          echo "## ðŸ“„ Robot Framework Reports" >> $GITHUB_STEP_SUMMARY
          echo "[View Reports](${{ steps.deployment.outputs.page_url }}/merged-log.html)" >> $GITHUB_STEP_SUMMARY
